<Tabs>
<Tab heading="Overview">

<Warning>

This environment is not production-ready since it does not follow our 
recommendations for production-ready cluster deployments. Please refer to the 
Installing Nomad for Production and Consul VM production patterns pages for
more information.

- [Installing Nomad for Production](/nomad/docs/install/production)
- [Consul VM production patterns](/consul/tutorials/production-vms)

This goal of this sandbox is to serve as a development and testing environment. 
It is "production-lite" — the Nomad cluster enables TLS and access control lists 
(ACLs) for security but uses management and root tokens to simplify development 
and testing. We do not recommend using management or root tokens in production.

</Warning>

This is a Nomad cluster made up of one server and one client node. The server 
and client nodes are each running the Nomad agent and Consul agent. Both agents 
are configured with ACLs, gossip encryption, and TLS encryption.
The server node includes a running single-node Vault cluster that has been 
initialized and unsealed. The client node has a scoped token for reading secrets 
from Vault. You can also read Vault secrets from a Nomad jobspec.

**Quick Start**

This sandbox already configures tokens for Nomad, Consul, and Vault so you can
interact with the respective tools via the CLI.

```shell-session
$ env | grep "NOMAD\|CONSUL\|VAULT"
```

You can find the Nomad and Consul management tokens in /ops/configs/tokens and
use them to log in to the web UIs.

```shell-session
$ cat /ops/configs/tokens/nomad_mgmt.token
$ cat /ops/configs/tokens/consul_mgmt.token
```

You can find the Vault's unseal key, certificates, and root token in /ops/configs/vault.

```shell-session
$ cat /ops/configs/vault/vault_root.token
```

This sandbox includes sample Nomad jobs. Use the following commands to submit 
the jobs to Nomad:

```shell-session
$ nomad job run /ops/configs/jobspecs/2048.hcl
$ nomad job run /ops/configs/jobspecs/terramino.hcl
$ nomad job run /ops/configs/jobspecs/hashicups.hcl
```

</Tab>
<Tab heading="Architecture">

**Infrastructure:**

- Server node (node-01-server)
  - n1-standard-2 VM (2 vCPU, 7.5GB RAM, 128GB disk) 
    - Nomad agent configured and running
      - Access pre-configured with environment variables (NOMAD_*)
      - Management token saved to NOMAD_TOKEN
    - Consul agent configured and running
      - Access pre-configured with environment variables (CONSUL_*)
        - Management token saved to CONSUL_TOKEN
    - Vault agent configured and running
      - Access pre-configured with environment variables (VAULT_*)
        - Root token saved to VAULT_TOKEN

- Client node (node-02-client)
  - n1-standard-2 VM (2 vCPU, 7.5GB RAM, 128GB disk)
    - Nomad agent configured and running
    - Consul agent configured and running
  - Vault access pre-configured with environment variables (VAULT_*)
  - Nomad drivers: `docker`, `exec`, `java`, `raw_exec`

**Directory structure:**

Environment related files are in the `/ops` directory.

<CodeBlockConfig hideClipboard>

```
/ops
└── configs
    ├── agentfiles
    │   ├── consul_server.hcl
    │   └── nomad_server.hcl
    ├── env-info
    │   ├── ARCHITECTURE
    │   ├── LIMITATIONS
    │   └── README
    ├── jobspecs
    │   ├── 2048.hcl
    │   ├── hashicups.hcl
    │   └── terramino.hcl
    ├── tokens
    │   ├── consul_agent_server.token
    │   ├── consul_dns.token
    │   ├── consul_gossip_key
    │   ├── consul_mgmt.token
    │   ├── nomad_gossip_key
    │   ├── nomad_mgmt.token
    │   └── nomad_node_join.token
    └── vault
        ├── data
        ├── dev-app-secrets.token
        ├── unseal.key
        ├── vault-cert.pem
        ├── vault-key.pem
        ├── vault-server.hcl
        └── vault_root.token
```

</CodeBlockConfig>

Logs are output to the /tmp directory.

```shell-session
$ ls /tmp
├── consul.log
├── nomad.log
└── vault.log
```

**HashiCorp applications:**

The sandbox includes the following HashiCorp applications:

- Nomad
  - One server node and one client node
  - ACLs enabled
  - Gossip encryption enabled
  - TLS encryption enabled

- Consul
  - One server node and one client node
  - ACLs enabled
  - Gossip encryption enabled
  - TLS encryption enabled
  - DNS configured (.consul domain)

- Vault
  - TLS encryption enabled
  - Initialized and unsealed

</Tab>

<Tab heading="Configure and restart agents">

The agent files for Nomad and Consul exist in the /ops/configs/agentfiles
directory. Changes can be made to the agent configuration files and then the
tools can be restarted with the commands below.

```shell-session
$ pkill nomad
$ nomad agent \
  -config=/ops/configs/agentfiles/nomad_server.hcl \
  >> /tmp/nomad.log 2>&1 &
```

```shell-session
$ pkill consul
$ consul agent \
  -config-file=/ops/configs/agentfiles/consul_server.hcl \
  >> /tmp/consul.log 2>&1 &
```


</Tab>
<Tab heading="Limitations">

The cluster is made up of one server one and one client node which is not what
we recommend for production environments.

The Vault cluster consists of a single node. We do not recommend this for production
environments.

Nomad jobspecs must be configured to use one of the ports exposed through the
Instruqt web browser tabs interface: `3001`, `3333`, or `4444`.

</Tab>
</Tabs>